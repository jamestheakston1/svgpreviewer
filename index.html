<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVG Live Previewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #f7fafc;
        }
        .main-content {
            flex-grow: 1;
            display: flex;
            /* FIX: Increased padding to ensure content clears the fixed header */
            padding-top: 80px; 
        }
        textarea::-webkit-scrollbar {
            width: 8px;
        }
        textarea::-webkit-scrollbar-thumb {
            background-color: #a0aec0;
            border-radius: 4px;
        }
        textarea::-webkit-scrollbar-track {
            background-color: #edf2f7;
        }
        #error-message {
            transition: opacity 0.3s ease-in-out;
        }

        #zoom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #4f46e5;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: background 0.15s ease, transform 0.15s ease;
        }
        #zoom-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #4f46e5;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: none;
            transition: background 0.15s ease, transform 0.15s ease;
        }

        .auth-card-option {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .auth-card-option:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .separator {
            display: flex;
            align-items: center;
            text-align: center;
            margin: 1.5rem 0;
            color: #6b7280;
        }
        .separator::before,
        .separator::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid #d1d5db;
        }
        .separator:not(:empty)::before {
            margin-right: .5em;
        }
        .separator:not(:empty)::after {
            margin-left: .5em;
        }
    </style>
</head>
<body>

    <header class="fixed top-0 left-0 right-0 bg-white shadow-lg z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
            <h1 id="app-logo" class="text-xl font-extrabold text-indigo-700 cursor-pointer">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2 align-text-bottom text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                </svg>
                SVG Live Previewer
            </h1>
            
            <div id="auth-status" class="flex items-center space-x-3">
                </div>
        </div>
    </header>

    <div class="main-content flex flex-col w-full max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">

        <div id="editor-view" class="flex flex-col lg:flex-row w-full flex-grow">
            <div class="w-full lg:w-1/2 p-0 flex flex-col border-b lg:border-r lg:border-b-0 border-gray-200">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">Paste Your SVG Code Here</h2>
                
                <div class="relative flex-grow min-h-[300px]">
                    
                    <textarea id="svg-input"
                              rows="10"
                              placeholder='Paste your <svg> block here. E.g., <svg width="100" height="100"><circle cx="50" cy="50" r="40" fill="#3b82f6"/></svg>'
                              class="w-full h-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 font-mono text-sm shadow-inner resize-none bg-gray-50 absolute inset-0 z-0"
                              spellcheck="false"></textarea>

                    <div id="demo-svg-container" class="absolute bottom-4 left-1/2 transform -translate-x-1/2 transition-opacity duration-500 ease-out z-20 bg-white p-4 shadow-2xl rounded-xl border border-indigo-200 w-11/12 max-w-lg">
                        <h3 class="text-sm font-semibold mb-3 text-gray-700 text-center">Click a Demo SVG to Load</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            
                            <button data-svg='<svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="45" fill="#34d399" stroke="#059669" stroke-width="5"/></svg>' 
                                    class="demo-card bg-white p-2 rounded-lg border border-gray-300 shadow-md hover:shadow-lg transition-shadow duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <div class="w-full h-16 flex items-center justify-center pointer-events-none">
                                    <svg width="60" height="60" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="45" fill="#34d399" stroke="#059669" stroke-width="5"/></svg>
                                </div>
                                <p class="text-xs text-center font-medium text-gray-600 mt-1">Simple Circle</p>
                            </button>
                            
                            <button data-svg='<svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M50 0 L61.8 38.2 L100 38.2 L69.1 61.8 L80.9 100 L50 76.4 L19.1 100 L30.9 61.8 L0 38.2 L38.2 38.2 Z" fill="#fbbf24" stroke="#d97706" stroke-width="3"/></svg>' 
                                    class="demo-card bg-white p-2 rounded-lg border border-gray-300 shadow-md hover:shadow-lg transition-shadow duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <div class="w-full h-16 flex items-center justify-center pointer-events-none">
                                    <svg width="60" height="60" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M50 0 L61.8 38.2 L100 38.2 L69.1 61.8 L80.9 100 L50 76.4 L19.1 100 L30.9 61.8 L0 38.2 L38.2 38.2 Z" fill="#fbbf24" stroke="#d97706" stroke-width="3"/></svg>
                                </div>
                                <p class="text-xs text-center font-medium text-gray-600 mt-1">Star Path</p>
                            </button>
                            
                            <button data-svg='<svg width="200" height="50" viewBox="0 0 200 50" xmlns="http://www.w3.org/2000/svg"><text x="10" y="35" font-family="Verdana" font-size="30" fill="#f43f5e">Hello SVG!</text><line x1="10" y1="40" x2="150" y2="40" stroke="#f43f5e" stroke-width="2"/></svg>' 
                                    class="demo-card bg-white p-2 rounded-lg border border-gray-300 shadow-md hover:shadow-lg transition-shadow duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <div class="w-full h-16 flex items-center justify-center pointer-events-none">
                                    <svg width="100" height="30" viewBox="0 0 200 50" xmlns="http://www.w3.org/2000/svg"><text x="10" y="35" font-family="Verdana" font-size="30" fill="#f43f5e">Text</text></svg>
                                </div>
                                <p class="text-xs text-center font-medium text-gray-600 mt-1">Example Text</p>
                            </button>
                            
                            <button data-svg='<svg viewBox="0 0 16 11" height="11" width="16" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M11.0714 0.652832C10.991 0.585124 10.8894 0.55127 10.7667 0.55127C10.6186 0.55127 10.4916 0.610514 10.3858 0.729004L4.19688 8.36523L1.79112 6.09277C1.7488 6.04622 1.69802 6.01025 1.63877 5.98486C1.57953 5.95947 1.51817 5.94678 1.45469 5.94678C1.32351 5.94678 1.20925 5.99544 1.11192 6.09277L0.800883 6.40381C0.707784 6.49268 0.661235 6.60482 0.661235 6.74023C0.661235 6.87565 0.707784 6.98991 0.800883 7.08301L3.79698 10.0791C3.94509 10.2145 4.11224 10.2822 4.29844 10.2822C4.40424 10.2822 4.5058 10.259 4.60313 10.2124C4.70046 10.1659 4.78086 10.1003 4.84434 10.0156L11.4903 1.59863C11.5623 1.5013 11.5982 1.40186 11.5982 1.30029C11.5982 1.14372 11.5348 1.01888 11.4078 0.925781L11.0714 0.652832ZM8.6212 8.32715C8.43077 8.20866 8.2488 8.09017 8.0753 7.97168C7.99489 7.89128 7.8891 7.85107 7.75791 7.85107C7.6098 7.85107 7.48920 7.90397 7.39610 8.00977L7.10411 8.33984C7.01947 8.43717 6.97715 8.54508 6.97715 8.66357C6.97715 8.79476 7.02370 8.90902 7.11680 9.00635L8.19590 10.0791C8.33132 10.2145 8.49636 10.2822 8.69102 10.2822C8.79681 10.2822 8.89838 10.259 8.99571 10.2124C9.09304 10.1659 9.17556 10.1003 9.24327 10.0156L15.8639 1.62402C15.9358 1.53939 15.9718 1.43994 15.9718 1.32568C15.9718 1.18180 15.9125 1.05697 15.7940 0.951172L15.4386 0.678223C15.3582 0.610514 15.2587 0.576660 15.1402 0.576660C14.9964 0.576660 14.8715 0.635905 14.7657 0.754395L8.62120 8.32715Z" fill="currentColor"/></svg>' 
                                    class="demo-card bg-white p-2 rounded-lg border border-gray-300 shadow-md hover:shadow-lg transition-shadow duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <div class="w-full h-16 flex items-center justify-center pointer-events-none">
                                    <svg width="60" height="40" viewBox="0 0 16 11" fill="#4f46e5" xmlns="http://www.w3.org/2000/svg"><path d="M11.0714 0.652832C10.991 0.585124 10.8894 0.55127 10.7667 0.55127C10.6186 0.55127 10.4916 0.610514 10.3858 0.729004L4.19688 8.36523L1.79112 6.09277C1.7488 6.04622 1.69802 6.01025 1.63877 5.98486C1.57953 5.95947 1.51817 5.94678 1.45469 5.94678C1.32351 5.94678 1.20925 5.99544 1.11192 6.09277L0.800883 6.40381C0.707784 6.49268 0.661235 6.60482 0.661235 6.74023C0.661235 6.87565 0.707784 6.98991 0.800883 7.08301L3.79698 10.0791C3.94509 10.2145 4.11224 10.2822 4.29844 10.2822C4.40424 10.2822 4.5058 10.259 4.60313 10.2124C4.70046 10.1659 4.78086 10.1003 4.84434 10.0156L11.4903 1.59863C11.5623 1.5013 11.5982 1.40186 11.5982 1.30029C11.5982 1.14372 11.5348 1.01888 11.4078 0.925781L11.0714 0.652832ZM8.6212 8.32715C8.43077 8.20866 8.2488 8.09017 8.0753 7.97168C7.99489 7.89128 7.8891 7.85107 7.75791 7.85107C7.6098 7.85107 7.48920 7.90397 7.39610 8.00977L7.10411 8.33984C7.01947 8.43717 6.97715 8.54508 6.97715 8.66357C6.97715 8.79476 7.02370 8.90902 7.11680 9.00635L8.19590 10.0791C8.33132 10.2145 8.49636 10.2822 8.69102 10.2822C8.79681 10.2822 8.89838 10.259 8.99571 10.2124C9.09304 10.1659 9.17556 10.1003 9.24327 10.0156L15.8639 1.62402C15.9358 1.53939 15.9718 1.43994 15.9718 1.32568C15.9718 1.18180 15.9125 1.05697 15.7940 0.951172L15.4386 0.678223C15.3582 0.610514 15.2587 0.576660 15.1402 0.576660C14.9964 0.576660 14.8715 0.635905 14.7657 0.754395L8.62120 8.32715Z" fill="currentColor"/></svg>
                                </div>
                                <p class="text-xs text-center font-medium text-gray-600 mt-1">Delivered Check</p>
                            </button>

                        </div>
                    </div>
                </div>

                <div id="error-message" class="mt-3 p-3 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-lg opacity-0 pointer-events-none">
                    <p class="font-bold">Invalid SVG Code</p>
                    <p>The code you entered could not be rendered. Please ensure it is valid XML/SVG markup.</p>
                </div>
            </div>

            <div class="w-full lg:w-1/2 p-0 flex flex-col">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">Live Preview</h2>
                
                <div class="relative p-3 mb-4 bg-gray-100 rounded-lg shadow-inner"> 
                    
                    <div class="flex justify-end -mt-1 mb-2 relative group">
                        <button id="auto-zoom-btn" class="flex items-center text-xs font-semibold text-indigo-600 hover:text-indigo-800 transition cursor-pointer focus:outline-none" 
                                title="Open Automatic Zoom Settings">
                            
                            <i data-feather="zoom-in" class="w-4 h-4 mr-1 text-indigo-500 group-hover:text-indigo-700 transition"></i>
                            <span class="hover:underline">Automatically Zoom</span>
                        </button>
                        
                        <div id="zoom-status-tooltip" class="absolute right-0 top-full mt-2 hidden group-hover:block w-48 bg-gray-800 text-white text-xs p-2 rounded-lg shadow-xl z-20 opacity-0 group-hover:opacity-100 transition duration-150 transform translate-y-2 group-hover:translate-y-0">
                            <p id="tooltip-status-text"></p>
                            <p class="mt-1 text-gray-300">Click to configure settings.</p>
                            <div class="absolute w-2 h-2 bg-gray-800 transform rotate-45 -top-1 right-3"></div>
                        </div>
                    </div>
                    
                    <div id="normal-marker" class="absolute top-3 transform -translate-x-1/2 flex flex-col items-center" style="left: 18%;">
                        <span class="text-xs font-medium text-gray-500">Normal</span>
                        <div class="h-2 w-px bg-gray-400"></div>
                    </div>

                    <div class="flex items-center space-x-3 mt-2">
                        <label for="zoom-slider" class="text-sm font-medium text-gray-700 whitespace-nowrap">Zoom:</label>
                        <input type="range" id="zoom-slider" min="50" max="1000" value="120" step="1"
                               class="flex-grow h-2 bg-indigo-200 rounded-lg appearance-none cursor-pointer zoom-slider-state-controlled transition-all duration-300">
                        
                        <span id="zoom-value" class="w-12 text-right font-semibold text-indigo-700">120%</span>
                    </div>
                </div>

                <div class="flex-grow flex items-center justify-center p-6 bg-white border border-gray-300 rounded-lg shadow-xl relative overflow-auto">
                    
                    <button id="save-svg-btn" title="Save SVG to your account" disabled
                            class="absolute bottom-4 right-4 z-30 p-2 bg-green-500 text-white rounded-full shadow-lg hover:bg-green-600 transition duration-150 focus:outline-none focus:ring-4 focus:ring-green-300 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i data-feather="save" class="w-5 h-5"></i>
                    </button>

                    <div id="svg-preview" class="transition-transform duration-200 ease-out" style="transform-origin: 50% 50%;">
                    </div>

                    <div id="placeholder" class="absolute inset-0 flex items-center justify-center bg-gray-50 bg-opacity-70 transition-opacity duration-300">
                        <p class="text-gray-500 italic p-4 text-center">Your SVG image will appear here once you paste the code.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="saved-svgs-view" class="w-full flex-grow p-4 hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center justify-between">
                Your Saved SVGs
                <button id="add-new-svg-btn" class="px-3 py-1 bg-indigo-600 text-white text-sm font-medium rounded-lg shadow-md hover:bg-indigo-700 transition flex items-center">
                    <i data-feather="plus" class="w-4 h-4 mr-1"></i> New SVG
                </button>
            </h2>
            
            <div id="saved-svgs-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                </div>

            <div id="empty-svgs-message" class="hidden text-center p-12 bg-white rounded-xl shadow-lg border border-dashed border-gray-300">
                <i data-feather="box" class="w-10 h-10 text-gray-400 mx-auto mb-4"></i>
                <p class="text-xl font-semibold text-gray-600">No SVGs Saved Yet</p>
                <p class="text-gray-500 mt-2">Start creating in the editor and use the "Save" feature to see your designs here.</p>
                <button id="go-to-editor-btn" class="mt-6 px-6 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition">
                    Go to Editor
                </button>
            </div>
        </div>

        <div id="account-view" class="w-full flex-grow p-4 hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">My Account Settings</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg h-full">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i data-feather="info" class="w-5 h-5 mr-2 text-indigo-500"></i>
                        Profile Overview
                    </h3>
                    
                    <p class="text-sm text-gray-600 mb-4">Manage your basic account details.</p>

                    <div class="space-y-4">
                        <div class="bg-gray-50 p-3 rounded-lg border">
                            <p class="text-xs font-medium text-gray-500">Email</p>
                            <p id="account-email" class="font-semibold text-gray-700 break-all"></p>
                        </div>

                        <div class="bg-gray-50 p-3 rounded-lg border">
                            <p class="text-xs font-medium text-gray-500">Sign-in Method</p>
                            <div class="flex items-center">
                                <span id="account-provider" class="font-semibold text-gray-700 capitalize"></span>
                                <i data-feather="check-circle" class="w-5 h-5 ml-2 text-green-500"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg h-full"> 
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i data-feather="link" class="w-5 h-5 mr-2 text-indigo-500"></i>
                        Linked Accounts
                    </h3>
                    
                    <p class="text-sm text-gray-600 mb-4">Manage your connected social accounts. (Note: Only email accounts can link new providers.)</p>
                    
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border">
                            <div class="flex items-center space-x-3">
                                <img src="https://github.githubassets.com/assets/GitHub-Mark-ea2971cee799.png" alt="GitHub Logo" class="w-5 h-5">
                                <span class="font-medium text-gray-700">GitHub</span>
                            </div>
                            <button id="unlink-github-btn" class="text-red-500 hover:text-red-700 text-sm font-semibold flex items-center transition">
                                <i data-feather="unlink" class="w-4 h-4 mr-1"></i>
                                Unlink
                            </button>
                        </div>
                        
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border">
                            <div class="flex items-center space-x-3">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/3/33/Figma-logo.svg" alt="Figma Logo" class="w-5 h-5">
                                <span class="font-medium text-gray-700">Figma</span>
                            </div>
                            <button id="link-figma-btn" class="text-green-500 hover:text-green-700 text-sm font-semibold flex items-center transition">
                                <i data-feather="link" class="w-4 h-4 mr-1"></i>
                                Link
                            </button>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold text-gray-800 mb-6 border-b pb-3">Update Details</h3>

                    <form id="update-name-form" class="mb-8 p-4 border border-gray-200 rounded-lg bg-gray-50">
                        <h4 class="text-lg font-semibold text-gray-700 mb-4">Change Name</h4>
                        <div class="space-y-2">
                            <label for="new-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                            <input type="text" id="new-name" placeholder="Enter your full name" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <p id="name-message" class="text-sm mt-2 h-5 text-red-500"></p>
                        <button type="submit" id="update-name-btn"
                                class="mt-4 px-6 py-2 bg-indigo-600 text-white font-medium rounded-lg shadow-md hover:bg-indigo-700 transition duration-150">
                            Update Name
                        </button>
                    </form>

                    <form id="update-password-form" class="p-4 border border-gray-200 rounded-lg bg-gray-50">
                        <h4 class="text-lg font-semibold text-gray-700 mb-4">Change Password</h4>
                        <div class="space-y-2">
                            <label for="new-password" class="block text-sm font-medium text-gray-700">New Password</label>
                            <input type="password" id="new-password" placeholder="••••••••" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="space-y-2 mt-3">
                            <label for="confirm-password" class="block text-sm font-medium text-gray-700">Confirm Password</label>
                            <input type="password" id="confirm-password" placeholder="••••••••" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <p id="password-message" class="text-sm mt-2 h-5 text-red-500"></p>
                        <button type="submit" id="update-password-btn"
                                class="mt-4 px-6 py-2 bg-indigo-600 text-white font-medium rounded-lg shadow-md hover:bg-indigo-700 transition duration-150">
                            Update Password
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <div id="settings-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div id="settings-card" class="bg-white rounded-xl shadow-2xl w-full max-w-lg m-4 transform transition-all duration-300 scale-95">
            
            <div class="p-6 border-b border-gray-200 flex items-center justify-between">
                <h3 id="modal-title" class="text-xl font-bold text-gray-800 flex items-center">
                    <i data-feather="zoom-in" class="w-6 h-6 mr-2 text-indigo-600"></i>
                    Automatic Zoom Settings
                </h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 focus:outline-none p-1 rounded-full hover:bg-gray-100 transition">
                    <i data-feather="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="p-6">
                
                <div class="flex items-center justify-between bg-gray-50 p-4 rounded-lg border border-gray-200 shadow-sm">
                    <label for="auto-zoom-toggle" class="text-base font-semibold text-gray-700">Automatically Zoom</label>
                    
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="auto-zoom-toggle" class="sr-only peer" checked>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] peer-checked:after:bg-white after:bg-white after:border after:border-gray-300 after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                    </label>
                </div>

                <div class="mt-6 space-y-4 text-gray-600 text-sm">
                    <p>This setting controls whether the SVG preview scales automatically to ensure the entire graphic is visible within the preview box, even if its intrinsic dimensions are large or small.</p>
                    <p>When <strong>enabled</strong>, the zoom level will be calculated based on the SVG's <code>viewBox</code> and the container size, overriding the manual zoom slider. The slider will reflect the calculated zoom percentage.</p>
                    <p>When <strong>disabled</strong>, the zoom reverts to the manual slider value, allowing you to control the exact scale of the preview.</p>
                </div>
                
            </div>
            
            <div class="p-4 border-t border-gray-200 flex justify-end">
                <button id="close-modal-footer-btn" class="px-4 py-2 bg-indigo-600 text-white font-medium rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150">
                    Close
                </button>
            </div>
        </div>
    </div>
    
    <div id="auth-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none" role="dialog" aria-modal="true" aria-labelledby="auth-modal-title">
        <div id="auth-card" class="bg-white rounded-xl shadow-2xl w-full max-w-sm m-4 transform transition-all duration-300 scale-95">
            
            <div class="p-6 border-b border-gray-200 flex items-center justify-between">
                <h3 id="auth-modal-title" class="text-xl font-bold text-gray-800 flex items-center">
                    <i data-feather="user" class="w-6 h-6 mr-2 text-indigo-600"></i>
                    <span id="auth-modal-header-text">Get Started</span>
                </h3>
                <button id="close-auth-modal-btn" class="text-gray-400 hover:text-gray-600 focus:outline-none p-1 rounded-full hover:bg-gray-100 transition">
                    <i data-feather="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div id="auth-body-content">

                <div id="auth-choice-view" class="p-6 space-y-4">
                    <p class="text-center text-gray-600 text-sm mb-6">Choose how you want to proceed:</p>
                    
                    <button id="show-signin-options-btn" class="auth-card-option w-full p-4 bg-white border-2 border-indigo-200 rounded-lg shadow-lg text-left hover:border-indigo-500 focus:outline-none focus:ring-4 focus:ring-indigo-200">
                        <div class="flex items-center space-x-3">
                            <i data-feather="log-in" class="w-6 h-6 text-indigo-600"></i>
                            <span class="text-lg font-semibold text-gray-800">Sign In</span>
                        </div>
                        <p class="text-sm text-gray-500 mt-1 ml-9">I already have an account.</p>
                    </button>

                    <button id="show-signup-options-btn" class="auth-card-option w-full p-4 bg-white border-2 border-green-200 rounded-lg shadow-lg text-left hover:border-green-500 focus:outline-none focus:ring-4 focus:ring-green-200">
                        <div class="flex items-center space-x-3">
                            <i data-feather="user-plus" class="w-6 h-6 text-green-600"></i>
                            <span class="text-lg font-semibold text-gray-800">Create Account</span>
                        </div>
                        <p class="text-sm text-gray-500 mt-1 ml-9">I'm new here and want to sign up.</p>
                    </button>
                </div>

                <div id="sign-in-options-view" class="p-6 space-y-4 hidden">
                    <button id="show-email-signin-btn" class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-lg shadow-md text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150">
                        <i data-feather="mail" class="w-5 h-5 mr-3"></i>
                        Sign in with Email
                    </button>
                    
                    <div class="separator">
                        <span class="px-2 text-xs font-semibold uppercase tracking-wider">Social Login</span>
                    </div>
                    
                    <button data-provider="github" class="social-signin-btn w-full flex justify-center items-center py-3 px-4 mb-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition duration-150">
                        <img src="https://github.githubassets.com/assets/GitHub-Mark-ea2971cee799.png" alt="GitHub Logo" class="w-5 h-5 mr-3">
                        Continue with GitHub
                    </button>

                    <button data-provider="figma" class="social-signin-btn w-full flex justify-center items-center py-3 px-4 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition duration-150">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/3/33/Figma-logo.svg" alt="Figma Logo" class="w-5 h-5 mr-3">
                        Continue with Figma
                    </button>

                    <button type="button" id="back-to-auth-choice-btn-2"
                            class="w-full mt-4 text-sm text-gray-500 hover:text-indigo-600 transition">
                        ← Back to Get Started
                    </button>
                </div>

                <div id="sign-up-options-view" class="p-6 space-y-4 hidden">
                    <p class="text-center text-gray-600 text-sm mb-6 font-semibold">Choose a service to create your account:</p>
                    
                    <button data-provider="github" class="social-signup-btn w-full flex justify-center items-center py-3 px-4 mb-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition duration-150">
                        <img src="https://github.githubassets.com/assets/GitHub-Mark-ea2971cee799.png" alt="GitHub Logo" class="w-5 h-5 mr-3">
                        Create account with GitHub
                    </button>

                    <button data-provider="figma" class="social-signup-btn w-full flex justify-center items-center py-3 px-4 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition duration-150">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/3/33/Figma-logo.svg" alt="Figma Logo" class="w-5 h-5 mr-3">
                        Create account with Figma
                    </button>
                    
                    <div class="separator">
                        <span class="px-2 text-xs font-semibold uppercase tracking-wider">Email</span>
                    </div>

                    <button id="show-email-signup-btn" class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-lg shadow-md text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150">
                        <i data-feather="mail" class="w-5 h-5 mr-3"></i>
                        Create account with Email
                    </button>

                    <button type="button" id="back-to-auth-choice-btn-3"
                            class="w-full mt-4 text-sm text-gray-500 hover:text-indigo-600 transition">
                        ← Back to Get Started
                    </button>
                </div>


                <form id="auth-form" class="p-6 space-y-4 hidden">
                    <div class="space-y-1">
                        <label for="email" class="text-sm font-medium text-gray-700">Email Address</label>
                        <input type="email" id="email" required placeholder="you@example.com"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="space-y-1">
                        <label for="password" class="text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="password" required placeholder="••••••••"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    
                    <p id="auth-message" class="text-sm h-5 text-red-500"></p>

                    <div class="flex space-x-3 pt-2">
                        <button type="submit" data-action="signin" id="sign-in-btn-modal"
                                class="flex-1 px-4 py-2 bg-indigo-600 text-white font-medium rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 hidden">
                            Sign In
                        </button>
                        <button type="submit" data-action="signup" id="sign-up-btn-modal"
                                class="flex-1 px-4 py-2 bg-green-600 text-white font-medium rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-150 hidden">
                            Sign Up
                        </button>
                    </div>

                    <button type="button" id="back-from-email-form"
                            class="w-full mt-4 text-sm text-gray-500 hover:text-indigo-600 transition">
                        ← Back
                    </button>
                </form>
            </div>
            
        </div>
    </div>


    <script>
        
        if (!window.supabase) {
            console.error("Supabase library not loaded. Check the CDN script tag.");
        }
        
        const createClient = window.supabase.createClient; 
        
        const SUPABASE_URL = 'https://vyknxlkbmzivfrojnwwe.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ5a254bGtibXppdmZyb2pud3dlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzNzkxNTMsImV4cCI6MjA4MDk1NTE1M30.WhqSyYCUEtSxrgVFI52J_QIlV92nuGMkGGbafX-B3vI';
        const SAVED_SVGS_TABLE = 'saved_svgs'; // Supabase Table Name
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const input = document.getElementById('svg-input');
        const preview = document.getElementById('svg-preview');
        const placeholder = document.getElementById('placeholder');
        const errorMessage = document.getElementById('error-message');
        const demoContainer = document.getElementById('demo-svg-container'); 
        
        const zoomSlider = document.getElementById('zoom-slider');
        const zoomValue = document.getElementById('zoom-value');
        
        const settingsModal = document.getElementById('settings-modal');
        const settingsCard = document.getElementById('settings-card');
        const autoZoomBtn = document.getElementById('auto-zoom-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const closeModalFooterBtn = document.getElementById('close-modal-footer-btn');
        const autoZoomToggle = document.getElementById('auto-zoom-toggle');
        const tooltipStatusText = document.getElementById('tooltip-status-text');

        const authStatus = document.getElementById('auth-status');
        const authModal = document.getElementById('auth-modal');
        const authModalHeaderText = document.getElementById('auth-modal-header-text');
        const closeAuthModalBtn = document.getElementById('close-auth-modal-btn');
        
        const authChoiceView = document.getElementById('auth-choice-view');
        const signInOptionsView = document.getElementById('sign-in-options-view');
        const signUpOptionsView = document.getElementById('sign-up-options-view');
        const authForm = document.getElementById('auth-form'); 

        const showSigninOptionsBtn = document.getElementById('show-signin-options-btn');
        const showSignupOptionsBtn = document.getElementById('show-signup-options-btn');
        const showEmailSigninBtn = document.getElementById('show-email-signin-btn');
        const showEmailSignupBtn = document.getElementById('show-email-signup-btn');
        const backToAuthChoiceBtn2 = document.getElementById('back-to-auth-choice-btn-2');
        const backToAuthChoiceBtn3 = document.getElementById('back-to-auth-choice-btn-3');
        const backFromEmailFormBtn = document.getElementById('back-from-email-form');

        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const authMessage = document.getElementById('auth-message');
        const signInBtnModal = document.getElementById('sign-in-btn-modal');
        const signUpBtnModal = document.getElementById('sign-up-btn-modal');

        const appLogo = document.getElementById('app-logo');
        const editorView = document.getElementById('editor-view');
        const savedSvgsView = document.getElementById('saved-svgs-view');
        const accountView = document.getElementById('account-view');
        
        // New SVG Management Element References
        const savedSvgsList = document.getElementById('saved-svgs-list');
        const emptySvgsMessage = document.getElementById('empty-svgs-message');
        const goToEditorBtn = document.getElementById('go-to-editor-btn');
        const addNewSvgBtn = document.getElementById('add-new-svg-btn');
        const saveSvgBtn = document.getElementById('save-svg-btn');

        // Account View Elements
        const updateNameForm = document.getElementById('update-name-form');
        const newNameInput = document.getElementById('new-name');
        const nameMessage = document.getElementById('name-message');
        const accountEmail = document.getElementById('account-email');
        const accountProvider = document.getElementById('account-provider');
        const updatePasswordForm = document.getElementById('update-password-form');
        const newPasswordInput = document.getElementById('new-password');
        const confirmPasswordInput = document.getElementById('confirm-password');
        const passwordMessage = document.getElementById('password-message');

        const DEFAULT_ZOOM = 120;
        let isSigningIn = false;
        let currentAuthView = 'choice';
        let currentUser = null;
        let isUpdatingAccount = false;

        // --- Core Functions for SVG Handling and Supabase Interaction ---

        /**
         * Prompts the user for a name and saves the current SVG code to Supabase.
         */
        async function saveCurrentSvg() {
            if (!currentUser) {
                alert("You must be logged in to save an SVG.");
                openAuthModal();
                return;
            }
            
            const svgCode = input.value.trim();
            if (svgCode === '' || !svgCode.startsWith('<svg')) {
                alert("The editor is empty or contains invalid SVG code.");
                return;
            }

            const svgName = prompt("Enter a name for your SVG:", "Untitled SVG");
            
            if (!svgName || svgName.trim() === '') {
                alert("Save cancelled. An SVG name is required.");
                return;
            }

            saveSvgBtn.disabled = true;
            saveSvgBtn.innerHTML = '<i data-feather="loader" class="w-5 h-5 animate-spin"></i>';
            feather.replace();

            try {
                const { error } = await supabase
                    .from(SAVED_SVGS_TABLE)
                    .insert({
                        user_id: currentUser.id,
                        name: svgName.trim(),
                        svg_code: svgCode
                    });

                if (error) throw error;

                alert(`SVG "${svgName.trim()}" saved successfully!`);

            } catch (error) {
                console.error('Error saving SVG:', error);
                alert(`Failed to save SVG: ${error.message}`);
            } finally {
                saveSvgBtn.disabled = false;
                saveSvgBtn.innerHTML = '<i data-feather="save" class="w-5 h-5"></i>';
                feather.replace();
            }
        }

        /**
         * Builds the HTML card for a single saved SVG item.
         * @param {object} svgData - The SVG object from Supabase (e.g., {id, name, svg_code, created_at})
         */
        function renderSavedSVGCard(svgData) {
            const card = document.createElement('div');
            card.className = 'bg-white p-6 rounded-xl shadow-lg border border-gray-200 hover:shadow-xl transition duration-200 flex flex-col';
            
            // Format the date
            const date = new Date(svgData.created_at).toLocaleDateString('en-US', {
                year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
            });

            // Use the full SVG code for the preview, adjusting its size.
            // Replace width/height attributes to ensure it scales correctly within the preview box
            const previewSvg = svgData.svg_code.replace(/width=".*?"|height=".*?"/gi, '').replace('<svg', '<svg style="max-width: 100%; max-height: 100%;"');

            const previewContainer = `<div class="flex items-center justify-center w-full h-32 bg-gray-100 mb-4 rounded-lg overflow-hidden p-2">
                ${previewSvg}
            </div>`;

            card.innerHTML = `
                ${previewContainer}
                <h3 class="text-lg font-semibold text-gray-700 truncate mb-1">${svgData.name || 'Untitled SVG'}</h3>
                <p class="text-sm text-gray-500">Saved: ${date}</p>
                <div class="mt-4 flex space-x-3">
                    <button data-id="${svgData.id}" class="load-to-editor-btn flex-1 px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition">
                        <i data-feather="edit-3" class="w-4 h-4 mr-1 inline-block align-text-bottom"></i>
                        Load to Editor
                    </button>
                    <button data-id="${svgData.id}" class="delete-svg-btn px-3 py-2 text-sm font-medium text-red-600 bg-red-50 rounded-lg hover:bg-red-100 transition" title="Delete SVG">
                        <i data-feather="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            `;

            // Add event listeners directly to the buttons after creation
            card.querySelector('.load-to-editor-btn').addEventListener('click', () => loadSvgToEditor(svgData.svg_code));
            card.querySelector('.delete-svg-btn').addEventListener('click', () => deleteSvg(svgData.id));

            return card;
        }

        /**
         * Fetches all saved SVGs for the current user and renders them.
         */
        async function fetchAndRenderSavedSVGs() {
            if (!currentUser) {
                savedSvgsList.innerHTML = '<p class="text-center text-red-500 col-span-full">Please sign in to view your saved SVGs.</p>';
                emptySvgsMessage.classList.add('hidden');
                return;
            }
            
            savedSvgsList.innerHTML = '<p class="text-center text-gray-500 col-span-full py-8"><i data-feather="loader" class="w-6 h-6 inline-block animate-spin mr-2"></i> Loading SVGs...</p>';
            emptySvgsMessage.classList.add('hidden');
            feather.replace();

            // 1. Fetch the saved SVGs from the database
            const { data, error } = await supabase
                .from(SAVED_SVGS_TABLE)
                .select('*')
                .eq('user_id', currentUser.id) // Filter by the currently authenticated user
                .order('created_at', { ascending: false }); // Show newest first

            savedSvgsList.innerHTML = ''; // Clear loading message

            if (error) {
                console.error('Error fetching SVGs:', error);
                savedSvgsList.innerHTML = `<p class="text-center text-red-500 col-span-full py-8">Error loading SVGs: ${error.message}</p>`;
                return;
            }

            // 2. Render the fetched SVGs
            if (data && data.length > 0) {
                data.forEach(svgData => {
                    savedSvgsList.appendChild(renderSavedSVGCard(svgData));
                });
                emptySvgsMessage.classList.add('hidden');
                feather.replace();
            } else {
                // Show empty state
                emptySvgsMessage.classList.remove('hidden');
                feather.replace();
            }
        }

        /**
         * Loads the SVG code into the editor and switches to the editor view.
         * @param {string} svgCode - The SVG code to load.
         */
        function loadSvgToEditor(svgCode) {
            if (input) {
                input.value = svgCode;
                // Trigger the input event to update the preview automatically
                input.dispatchEvent(new Event('input', { bubbles: true })); 
            }
            showView('editor'); 
        }

        /**
         * Deletes an SVG entry from the database.
         * @param {string} id - The ID of the SVG to delete.
         */
        async function deleteSvg(id) {
            if (!confirm("Are you sure you want to delete this SVG? This cannot be undone.")) {
                return;
            }

            try {
                const { error } = await supabase
                    .from(SAVED_SVGS_TABLE)
                    .delete()
                    .eq('id', id);

                if (error) throw error;
                
                // Re-fetch and re-render the list to update the UI
                fetchAndRenderSavedSVGs();
                
            } catch (error) {
                alert(`Error deleting SVG: ${error.message}`);
                console.error('Delete error:', error);
            }
        }
        
        // --- End SVG Core Functions ---


        function showView(viewId) {
            const views = {
                'editor': editorView,
                'saved-svgs': savedSvgsView,
                'account': accountView
            };
            
            Object.values(views).forEach(view => {
                view.classList.add('hidden');
                // Ensure editor view retains its special flex layout when visible
                if (view.id === 'editor-view') {
                    view.classList.remove('flex-col', 'lg:flex-row', 'flex-grow');
                }
            });

            const targetView = views[viewId];
            if (targetView) {
                targetView.classList.remove('hidden');
                 if (viewId === 'editor') {
                    targetView.classList.add('flex-col', 'lg:flex-row', 'flex-grow');
                }
            }
            
            if (viewId === 'account') {
                loadAccountData(currentUser);
            } else if (viewId === 'saved-svgs') {
                fetchAndRenderSavedSVGs(); // Call fetch function when viewing saved SVGs
            }
            // Close dropdown if open
            const dropdown = document.getElementById('profile-dropdown-menu');
            if (dropdown) dropdown.classList.add('hidden');
        }

        function showAuthMessage(element, message, isError = false) {
            element.textContent = message;
            element.className = isError ? 'text-sm mt-2 h-5 text-red-500' : 'text-sm mt-2 h-5 text-green-500';
            if (element === authMessage) element.className = isError ? 'text-sm h-5 text-red-500' : 'text-sm h-5 text-green-500';
        }

        function showAuthView(view) {
            currentAuthView = view;
            
            authForm.classList.add('hidden');
            authChoiceView.classList.add('hidden');
            signInOptionsView.classList.add('hidden');
            signUpOptionsView.classList.add('hidden');

            signInBtnModal.classList.add('hidden');
            signUpBtnModal.classList.add('hidden');
            authMessage.textContent = '';
            
            if (view === 'choice') {
                authModalHeaderText.textContent = 'Get Started';
                authChoiceView.classList.remove('hidden');
            } else if (view === 'signin-options') {
                authModalHeaderText.textContent = 'Sign In';
                signInOptionsView.classList.remove('hidden');
            } else if (view === 'signup-options') {
                authModalHeaderText.textContent = 'Create Account';
                signUpOptionsView.classList.remove('hidden');
            } else if (view === 'email-signin') {
                authModalHeaderText.textContent = 'Sign In with Email';
                authForm.classList.remove('hidden');
                signInBtnModal.classList.remove('hidden');
            } else if (view === 'email-signup') {
                authModalHeaderText.textContent = 'Create Account with Email';
                authForm.classList.remove('hidden');
                signUpBtnModal.classList.remove('hidden');
            }
        }

        function openAuthModal() {
            showAuthView('choice'); 
            authModal.classList.remove('opacity-0', 'pointer-events-none');
            emailInput.value = '';
            passwordInput.value = '';
        }

        function closeAuthModal() {
            authModal.classList.add('opacity-0', 'pointer-events-none');
        }

        async function handleAuthFormSubmit(event) {
            event.preventDefault();
            
            const action = currentAuthView === 'email-signin' ? 'signin' : 'signup';
            if (isSigningIn) return;

            const email = emailInput.value;
            const password = passwordInput.value;
            
            if (!email || !password) {
                showAuthMessage(authMessage, "Please enter both email and password.", true);
                return;
            }

            isSigningIn = true;
            showAuthMessage(authMessage, "Processing...", false);

            try {
                let response;
                if (action === 'signup') {
                    // Supabase automatically sets the name from the social profile on sign up, 
                    // but for email sign up, we can't set it here without extra info/DB setup.
                    response = await supabase.auth.signUp({ email, password });
                    if (response.error) throw response.error;
                    
                    if (response.data.session) {
                        showAuthMessage(authMessage, "Sign up successful and you are logged in!", false);
                        setTimeout(closeAuthModal, 1000); 
                    } else {
                        showAuthMessage(authMessage, "Sign up successful. Please check your email to confirm.", false);
                        showAuthView('email-signin'); 
                    }

                } else if (action === 'signin') {
                    response = await supabase.auth.signInWithPassword({ email, password });
                    if (response.error) throw response.error;
                    closeAuthModal();
                }

            } catch (error) {
                showAuthMessage(authMessage, error.message, true);
            } finally {
                isSigningIn = false;
            }
        }

        async function handleSocialSignIn(provider) {
            if (isSigningIn) return;

            const supportedProviders = ['github', 'figma']; 
            
            isSigningIn = true;
            const providerName = provider.charAt(0).toUpperCase() + provider.slice(1);
            showAuthMessage(authMessage, `Initiating Authentication with ${providerName}...`, false);

            if (!supportedProviders.includes(provider)) {
                showAuthMessage(authMessage, `'${providerName}' is for UI demonstration. Supabase sign-in not configured for this provider in this demo.`, true);
                isSigningIn = false;
                return;
            }

            try {
                const { error } = await supabase.auth.signInWithOAuth({
                    provider: provider,
                    options: {
                        redirectTo: window.location.origin, 
                    },
                });

                if (error) {
                    throw error;
                }

            } catch (error) {
                showAuthMessage(authMessage, `Authentication failed: ${error.message}`, true);
                console.error("Social Auth Error:", error);
            } finally {
                isSigningIn = false;
            }
        }
        
        async function handleSignOut() {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
            } catch (error) {
                console.error("Sign Out Error:", error.message);
            }
        }

        function getInitials(user) {
            const displayName = user.user_metadata?.full_name || user.email || 'User';
            const parts = displayName.split(' ');
            let initials = '';
            if (parts.length > 0) initials += parts[0][0];
            if (parts.length > 1) initials += parts[parts.length - 1][0];
            return initials.toUpperCase() || 'U';
        }

        function toggleDropdown() {
            const dropdown = document.getElementById('profile-dropdown-menu');
            dropdown.classList.toggle('hidden');
        }

        function updateAuthUI(user) {
            currentUser = user;
            authStatus.innerHTML = ''; 

            if (user) {
                // Render Profile Icon and Dropdown
                const profileContainer = document.createElement('div');
                profileContainer.className = 'relative';

                const profileBtn = document.createElement('button');
                profileBtn.id = 'profile-menu-btn';
                profileBtn.className = 'w-10 h-10 rounded-full bg-indigo-500 text-white font-semibold flex items-center justify-center shadow-lg hover:ring-4 hover:ring-indigo-300 transition duration-150 focus:outline-none';
                profileBtn.textContent = getInitials(user);
                profileBtn.addEventListener('click', toggleDropdown);

                const dropdownMenu = document.createElement('div');
                dropdownMenu.id = 'profile-dropdown-menu';
                dropdownMenu.className = 'hidden absolute right-0 mt-3 w-48 bg-white rounded-lg shadow-xl py-1 z-20 border border-gray-200';
                
                // Dropdown Content
                const usernameDisplay = user.user_metadata?.full_name || user.email;
                
                // Header (non-clickable)
                const header = document.createElement('div');
                header.className = 'px-4 py-2 text-xs text-gray-500 truncate border-b mb-1';
                header.textContent = `Signed in as: ${usernameDisplay}`;
                dropdownMenu.appendChild(header);


                // Saved SVGs
                const savedSvgsLink = document.createElement('a');
                savedSvgsLink.className = 'flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer transition';
                savedSvgsLink.innerHTML = '<i data-feather="bookmark" class="w-4 h-4 mr-3"></i>Saved SVGs';
                savedSvgsLink.addEventListener('click', () => showView('saved-svgs'));
                dropdownMenu.appendChild(savedSvgsLink);

                // My Account
                const accountLink = document.createElement('a');
                accountLink.className = 'flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer transition';
                accountLink.innerHTML = '<i data-feather="settings" class="w-4 h-4 mr-3"></i>My Account';
                accountLink.addEventListener('click', () => showView('account'));
                dropdownMenu.appendChild(accountLink);
                
                // Separator
                const separator = document.createElement('div');
                separator.className = 'border-t my-1';
                dropdownMenu.appendChild(separator);

                // Logout
                const logoutLink = document.createElement('a');
                logoutLink.className = 'flex items-center px-4 py-2 text-sm text-red-600 hover:bg-red-50 cursor-pointer transition';
                logoutLink.innerHTML = '<i data-feather="log-out" class="w-4 h-4 mr-3"></i>Logout';
                logoutLink.addEventListener('click', handleSignOut);
                dropdownMenu.appendChild(logoutLink);

                profileContainer.appendChild(profileBtn);
                profileContainer.appendChild(dropdownMenu);
                authStatus.appendChild(profileContainer);
                
            } else {
                // Render Sign In Button
                const signInBtn = document.createElement('button');
                signInBtn.className = 'flex items-center px-3 py-1 bg-indigo-500 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-indigo-600 transition focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2';
                signInBtn.innerHTML = '<i data-feather="log-in" class="w-4 h-4 mr-1"></i>Sign In';
                signInBtn.addEventListener('click', openAuthModal);

                authStatus.appendChild(signInBtn);
            }
            
            feather.replace();
        }
        
        // --- Account View Logic ---
        function loadAccountData(user) {
            if (!user) return;
            
            accountEmail.textContent = user.email || 'N/A';
            
            const provider = user.app_metadata?.provider || 'email';
            accountProvider.textContent = provider.charAt(0).toUpperCase() + provider.slice(1);

            newNameInput.value = user.user_metadata?.full_name || '';

            // Disable password change for social sign-ins
            const isEmailUser = provider === 'email';
            newPasswordInput.disabled = !isEmailUser;
            confirmPasswordInput.disabled = !isEmailUser;
            updatePasswordForm.classList.toggle('opacity-50', !isEmailUser);
            updatePasswordForm.querySelector('h4').textContent = isEmailUser ? 'Change Password' : 'Password Management (Social Sign-in)';
            passwordMessage.textContent = isEmailUser ? '' : 'Password change is only available for accounts created with email.';
            passwordMessage.className = isEmailUser ? 'text-sm mt-2 h-5 text-red-500' : 'text-sm mt-2 h-5 text-gray-500';

            // Clear messages
            showAuthMessage(nameMessage, '');
            newPasswordInput.value = '';
            confirmPasswordInput.value = '';
        }

        async function handleNameUpdate(event) {
            event.preventDefault();
            if (isUpdatingAccount) return;

            const newName = newNameInput.value.trim();
            if (newName.length < 2) {
                showAuthMessage(nameMessage, "Name must be at least 2 characters.", true);
                return;
            }

            isUpdatingAccount = true;
            showAuthMessage(nameMessage, "Updating name...", false);
            
            try {
                const { data, error } = await supabase.auth.updateUser({ 
                    data: { full_name: newName } 
                });

                if (error) throw error;
                
                currentUser.user_metadata = data.user.user_metadata;
                showAuthMessage(nameMessage, "Name updated successfully!", false);
                updateAuthUI(currentUser); // Refresh header initials

            } catch (error) {
                showAuthMessage(nameMessage, `Error updating name: ${error.message}`, true);
            } finally {
                isUpdatingAccount = false;
            }
        }

        async function handlePasswordUpdate(event) {
            event.preventDefault();
            if (isUpdatingAccount) return;

            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;
            
            if (newPassword !== confirmPassword) {
                showAuthMessage(passwordMessage, "Passwords do not match.", true);
                return;
            }
            if (newPassword.length < 6) {
                showAuthMessage(passwordMessage, "Password must be at least 6 characters.", true);
                return;
            }

            isUpdatingAccount = true;
            showAuthMessage(passwordMessage, "Updating password...", false);

            try {
                const { error } = await supabase.auth.updateUser({ password: newPassword });

                if (error) throw error;

                showAuthMessage(passwordMessage, "Password updated successfully!", false);
                newPasswordInput.value = '';
                confirmPasswordInput.value = '';

            } catch (error) {
                showAuthMessage(passwordMessage, `Error updating password: ${error.message}`, true);
            } finally {
                isUpdatingAccount = false;
            }
        }
        
        // --- SVG Editor/Preview Logic ---
        function setZoomValueAnimated(targetZoom) {
            targetZoom = Math.min(1000, Math.max(50, Math.round(targetZoom)));

            let currentZoom = parseFloat(zoomSlider.value);
            const duration = 300;
            const startTime = performance.now();

            function step(timestamp) {
                const elapsed = timestamp - startTime;
                const progress = Math.min(1, elapsed / duration);
                
                const easedProgress = progress < 0.5 ? 2 * progress * progress : 1 - Math.pow(-2 * progress + 2, 2) / 2;
                
                const newZoom = currentZoom + (targetZoom - currentZoom) * easedProgress;
                
                zoomSlider.value = newZoom;
                applyZoom();

                if (progress < 1) {
                    requestAnimationFrame(step);
                } else {
                    zoomSlider.value = targetZoom;
                    applyZoom();
                }
            }
            requestAnimationFrame(step);
        }

        function openSettingsModal() {
            if (!settingsModal || !settingsCard) return;
            
            settingsModal.classList.remove('opacity-0', 'pointer-events-none');
            settingsCard.classList.remove('scale-95');
        }

        function closeSettingsModal() {
            if (!settingsModal || !settingsCard) return;
            
            settingsModal.classList.add('opacity-0', 'pointer-events-none');
            settingsCard.classList.add('scale-95');
        }

        function handleToggle() {
            const isChecked = autoZoomToggle.checked;
            
            tooltipStatusText.innerHTML = `Auto Zoom is <strong>${isChecked ? 'ON' : 'OFF'}</strong>.`;

            if (isChecked) {
                zoomSlider.classList.add('opacity-50', 'cursor-not-allowed');
                calculateAutoZoom();
            } else {
                zoomSlider.classList.remove('opacity-50', 'cursor-not-allowed');
                applyZoom(); 
            }
        }
        
        function calculateAutoZoom() {
            if (!autoZoomToggle.checked) return;

            const svgElement = preview.querySelector('svg');
            const previewContainer = preview.parentElement;

            if (!svgElement) {
                setZoomValueAnimated(DEFAULT_ZOOM);
                return;
            }

            const containerWidth = previewContainer.clientWidth - 48;
            const containerHeight = previewContainer.clientHeight - 48;
            
            let svgWidth, svgHeight;
            
            const viewBox = svgElement.getAttribute('viewBox');
            if (viewBox) {
                const parts = viewBox.split(/\s+|,/g).map(Number).filter(n => !isNaN(n));
                if (parts.length === 4) {
                    svgWidth = parts[2];
                    svgHeight = parts[3];
                }
            }

            if (!svgWidth || !svgHeight || svgWidth === 0 || svgHeight === 0) {
                svgWidth = parseFloat(svgElement.getAttribute('width')) || 100;
                svgHeight = parseFloat(svgElement.getAttribute('height')) || 100;
                
                if (svgWidth <= 0 || svgHeight <= 0) {
                    setZoomValueAnimated(DEFAULT_ZOOM);
                    return;
                }
            }
            
            const widthRatio = containerWidth / svgWidth;
            const heightRatio = containerHeight / svgHeight;

            const fitRatio = Math.min(widthRatio, heightRatio);

            let targetZoom = fitRatio * 100 * 0.95; 
            targetZoom = Math.min(1000, Math.max(50, targetZoom));

            setZoomValueAnimated(targetZoom);
        }


        function applyZoom() {
            const zoomPercentage = zoomSlider.value;
            const scaleFactor = zoomPercentage / 100;

            preview.style.transform = `scale(${scaleFactor})`;
            zoomValue.textContent = `${Math.round(zoomPercentage)}%`;
        }

        function updatePreview() {
            const svgCode = input.value.trim();

            preview.innerHTML = '';
            hideError();
            
            if (svgCode === '') {
                placeholder.classList.remove('opacity-0', 'pointer-events-none');
                
                if (autoZoomToggle.checked) {
                    setZoomValueAnimated(DEFAULT_ZOOM);
                } else {
                    applyZoom();
                }
                
                demoContainer.classList.remove('opacity-0', 'pointer-events-none');
                saveSvgBtn.disabled = true;
                return;
            }

            placeholder.classList.add('opacity-0', 'pointer-events-none');
            demoContainer.classList.add('opacity-0', 'pointer-events-none');


            try {
                if (!svgCode.startsWith('<svg') || !svgCode.endsWith('>')) {
                    throw new Error("Does not look like a complete <svg> tag.");
                }

                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = svgCode;

                const svgElement = tempDiv.querySelector('svg');

                if (svgElement) {
                    const hasScript = svgElement.querySelector('script');
                    if (hasScript) {
                        throw new Error("Scripts found. Script elements are blocked for safety.");
                    }

                    preview.appendChild(svgElement);
                    
                    if (autoZoomToggle.checked) {
                        calculateAutoZoom();
                    } else {
                        applyZoom(); 
                    }
                    
                    saveSvgBtn.disabled = false; // Enable save button on successful render

                } else {
                    throw new Error("No valid SVG element found inside the code.");
                }

            } catch (error) {
                console.error("SVG Rendering Error:", error);
                showError();
                placeholder.classList.remove('opacity-0', 'pointer-events-none');
                saveSvgBtn.disabled = true; // Disable save button on error
            }
        }

        let debounceTimer;
        function handleInput() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(updatePreview, 250);
            
            const svgCode = input.value.trim();
            if (svgCode.length > 0) {
                demoContainer.classList.add('opacity-0', 'pointer-events-none');
            } else {
                demoContainer.classList.remove('opacity-0', 'pointer-events-none');
            }
        }

        function showError() {
            errorMessage.classList.remove('opacity-0', 'pointer-events-none');
        }

        function hideError() {
            errorMessage.classList.add('opacity-0', 'pointer-events-none');
        }
        
        function loadDemoSvg(event) {
            const button = event.currentTarget;
            const svg = button.getAttribute('data-svg');
            
            input.value = svg;
            handleInput(); 
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            feather.replace();
            
            autoZoomToggle.checked = true;
            zoomSlider.value = DEFAULT_ZOOM; 
            handleToggle();

            updatePreview();
            showView('editor'); // Initialize to editor view

            window.addEventListener('resize', () => {
                if (autoZoomToggle.checked) {
                    calculateAutoZoom();
                }
            });

            supabase.auth.onAuthStateChange((event, session) => {
                updateAuthUI(session?.user);
                if (session) {
                    closeAuthModal();
                }
                if (!session) {
                    showView('editor'); // Go back to editor if logged out
                }
            });
            
            // Social Sign-in Buttons for the Sign In View
            document.querySelectorAll('.social-signin-btn').forEach(btn => {
                btn.addEventListener('click', () => handleSocialSignIn(btn.getAttribute('data-provider')));
            });

            // Social Sign-up Buttons for the Create Account View
            document.querySelectorAll('.social-signup-btn').forEach(btn => {
                btn.addEventListener('click', () => handleSocialSignIn(btn.getAttribute('data-provider')));
            });

            // Logo click goes home
            appLogo.addEventListener('click', () => showView('editor'));
        });

        input.addEventListener('input', handleInput);

        zoomSlider.addEventListener('input', () => {
            if (autoZoomToggle.checked) {
                autoZoomToggle.checked = false;
                handleToggle(); 
            }
            applyZoom();
        });

        document.querySelectorAll('.demo-card').forEach(card => {
            card.addEventListener('click', loadDemoSvg);
        });
        
        // Settings Modal Listeners
        autoZoomBtn.addEventListener('click', openSettingsModal);
        closeModalBtn.addEventListener('click', closeSettingsModal);
        closeModalFooterBtn.addEventListener('click', closeSettingsModal);
        autoZoomToggle.addEventListener('change', handleToggle);

        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                closeSettingsModal();
            }
        });
        
        // Auth Modal Listeners
        authForm.addEventListener('submit', handleAuthFormSubmit);
        closeAuthModalBtn.addEventListener('click', closeAuthModal);
        authModal.addEventListener('click', (e) => {
            if (e.target === authModal) {
                closeAuthModal();
            }
        });

        // Auth Navigation Listeners
        showSigninOptionsBtn.addEventListener('click', () => showAuthView('signin-options'));
        showSignupOptionsBtn.addEventListener('click', () => showAuthView('signup-options')); 
        
        showEmailSigninBtn.addEventListener('click', () => showAuthView('email-signin'));
        showEmailSignupBtn.addEventListener('click', () => showAuthView('email-signup'));
        
        backToAuthChoiceBtn2.addEventListener('click', () => showAuthView('choice'));
        backToAuthChoiceBtn3.addEventListener('click', () => showAuthView('choice')); 

        backFromEmailFormBtn.addEventListener('click', () => {
            if (currentAuthView === 'email-signup') {
                showAuthView('signup-options');
            } else if (currentAuthView === 'email-signin') {
                showAuthView('signin-options');
            }
        });

        // Account Update Listeners
        updateNameForm.addEventListener('submit', handleNameUpdate);
        updatePasswordForm.addEventListener('submit', handlePasswordUpdate);
        
        // New SVG Management Listeners
        saveSvgBtn.addEventListener('click', saveCurrentSvg);

        // Button to go back to editor from empty state
        goToEditorBtn.addEventListener('click', () => showView('editor'));

        // Plus button in the saved SVGs view (goes to editor to create new)
        addNewSvgBtn.addEventListener('click', () => showView('editor'));
    </script>

</body>
</html>
